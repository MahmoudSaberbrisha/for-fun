<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>دعوه انعقاد جمعيه عموميه</title>
    <link rel="stylesheet" href="/frontend/styles/style.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Cairo", Arial, sans-serif;
        background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
        min-height: 100vh;
        color: #222;
      }
      .container {
        display: flex;
        width: 100vw;
        min-height: 100vh;
        box-sizing: border-box;
      }
      .scroll-container {
        flex: 1;
        width: 100%;
        max-width: 100vw;
        min-height: 100vh;
        overflow: auto;
        border: none;
        padding: 40px 32px;
        background: linear-gradient(120deg, #ffffff 60%, #e0f2f1 100%);
        box-sizing: border-box;
        box-shadow: 0 0 16px 0 rgba(76, 175, 80, 0.07);
      }
      h1,
      h2 {
        color: #219150;
        margin-bottom: 24px;
        text-align: center;
        letter-spacing: 1px;
      }
      form#invitationForm {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px 0 rgba(76, 175, 80, 0.08);
        padding: 32px 24px;
        margin-bottom: 32px;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
      }
      .form-group {
        margin-bottom: 18px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #219150;
        font-weight: 600;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #b2dfdb;
        border-radius: 8px;
        background: #f8fffa;
        font-size: 1rem;
        transition: border 0.2s;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border: 1.5px solid #43a047;
        outline: none;
        background: #e8f5e9;
      }
      .button {
        padding: 10px 24px;
        margin-right: 8px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .button[type="submit"] {
        background: linear-gradient(90deg, #43a047 60%, #66bb6a 100%);
        color: #fff;
        box-shadow: 0 2px 8px 0 rgba(76, 175, 80, 0.12);
      }
      .button.edit {
        background: #43a047;
        color: #fff;
      }
      .button.edit:hover {
        background: #388e3c;
      }
      .button.delete {
        background: #e53935;
        color: #fff;
      }
      .button.delete:hover {
        background: #b71c1c;
      }
      .search-input {
        margin-bottom: 18px;
        padding: 10px 14px;
        width: 350px;
        border: 1px solid #b2dfdb;
        border-radius: 8px;
        background: #f8fffa;
        font-size: 1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 24px;
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 12px 0 rgba(76, 175, 80, 0.08);
      }
      th,
      td {
        border-bottom: 1px solid #e0f2f1;
        padding: 14px 8px;
        text-align: center;
        font-size: 1rem;
      }
      th {
        background: linear-gradient(90deg, #e8f5e9 60%, #b2dfdb 100%);
        color: #219150;
        font-weight: 700;
        border-bottom: 2px solid #43a047;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background: #f1f8e9;
        transition: background 0.2s;
      }
      @media (max-width: 900px) {
        .scroll-container {
          padding: 16px 4px;
        }
        form#invitationForm {
          padding: 18px 6px;
        }
        .search-input {
          width: 100%;
        }
        table,
        th,
        td {
          font-size: 0.95rem;
        }
      }
    </style>
  </head>
  <body>
    <%- include('partials/navbar') %>
    <div class="container" style="margin-top: 20px">
      <%- include('partials/sidebar') %>
      <div class="scroll-container">
        <h1>دعوه انعقاد جمعيه عموميه</h1>
        <form id="invitationForm">
          <div class="form-group">
            <label for="invitationNumber">رقم الدعوه</label>
            <input
              type="text"
              id="invitationNumber"
              name="invitationNumber"
              required
            />
          </div>
          <div class="form-group">
            <label for="invitationDate">تاريخ الدعوه</label>
            <input
              type="date"
              id="invitationDate"
              name="invitationDate"
              required
            />
          </div>
          <div class="form-group">
            <label for="meetingType">نوع الاجتماع</label>
            <input type="text" id="meetingType" name="meetingType" required />
          </div>
          <div class="form-group">
            <label for="memberName">اسم العضو</label>
            <input type="text" id="memberName" name="memberName" required />
          </div>
          <div class="form-group">
            <label for="memberTitleEnd">نهاية اللقب</label>
            <input
              type="text"
              id="memberTitleEnd"
              name="memberTitleEnd"
              required
            />
          </div>
          <div class="form-group">
            <label for="sessionNumber">رقم الجلسه</label>
            <input
              type="text"
              id="sessionNumber"
              name="sessionNumber"
              required
            />
          </div>
          <div class="form-group">
            <label for="meetingPlace">مكان الانعقاد</label>
            <input type="text" id="meetingPlace" name="meetingPlace" required />
          </div>
          <div class="form-group">
            <label for="subject">الموضوع</label>
            <textarea id="subject" name="subject" required></textarea>
          </div>
          <button type="submit" class="button">إضافة الدعوه</button>
        </form>

        <h2>الدعوات التي تمت بالفعل</h2>
        <input
          type="text"
          id="searchInvitations"
          class="search-input"
          placeholder="بحث"
        />
        <table id="invitationsTable">
          <thead>
            <tr>
              <th>رقم الدعوه</th>
              <th>تاريخ الدعوه</th>
              <th>نوع الاجتماع</th>
              <th>اسم العضو</th>
              <th>نهاية اللقب</th>
              <th>رقم الجلسه</th>
              <th>مكان الانعقاد</th>
              <th>الموضوع</th>
              <th>تعديل</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody>
            <% if (invitations && invitations.length > 0) { %> <%
            invitations.forEach(function(invitation) { %>
            <tr data-id="<%= invitation._id %>">
              <td><%= invitation.invitationNumber %></td>
              <td>
                <%= invitation.invitationDate ?
                invitation.invitationDate.toISOString().substring(0, 10) : '' %>
              </td>
              <td><%= invitation.meetingType %></td>
              <td><%= invitation.memberName %></td>
              <td><%= invitation.memberTitleEnd %></td>
              <td><%= invitation.sessionNumber %></td>
              <td><%= invitation.meetingPlace %></td>
              <td><%= invitation.subject %></td>
              <td>
                <button
                  class="button edit"
                  onclick="editInvitation('<%= invitation._id %>')"
                >
                  تعديل
                </button>
              </td>
              <td>
                <button
                  class="button delete"
                  onclick="deleteInvitation('<%= invitation._id %>')"
                >
                  حذف
                </button>
              </td>
            </tr>
            <% }); %> <% } else { %>
            <tr>
              <td colspan="10">لا توجد دعوات حالياً</td>
            </tr>
            <% } %>
          </tbody>
        </table>

        <script>
          // Handle invitation form submission
          document
            .getElementById("invitationForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              const formData = {
                invitationNumber: this.invitationNumber.value,
                invitationDate: this.invitationDate.value,
                meetingType: this.meetingType.value,
                memberName: this.memberName.value,
                memberTitleEnd: this.memberTitleEnd.value,
                sessionNumber: this.sessionNumber.value,
                meetingPlace: this.meetingPlace.value,
                subject: this.subject.value,
              };
              try {
                const response = await fetch("/api/invitations", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(formData),
                });
                if (response.ok) {
                  alert("تم إضافة الدعوه بنجاح");
                  location.reload();
                } else {
                  alert("حدث خطأ أثناء إضافة الدعوه");
                }
              } catch (error) {
                alert("خطأ في الاتصال بالخادم");
              }
            });

          // Edit invitation
          async function editInvitation(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
            const cells = row.querySelectorAll("td");
            const updatedInvitation = {
              invitationNumber: prompt("رقم الدعوه:", cells[0].textContent),
              invitationDate: prompt(
                "تاريخ الدعوه (YYYY-MM-DD):",
                cells[1].textContent
              ),
              meetingType: prompt("نوع الاجتماع:", cells[2].textContent),
              memberName: prompt("اسم العضو:", cells[3].textContent),
              memberTitleEnd: prompt("نهاية اللقب:", cells[4].textContent),
              sessionNumber: prompt("رقم الجلسه:", cells[5].textContent),
              meetingPlace: prompt("مكان الانعقاد:", cells[6].textContent),
              subject: prompt("الموضوع:", cells[7].textContent),
            };
            try {
              const response = await fetch("/api/invitations/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedInvitation),
              });
              if (response.ok) {
                alert("تم تحديث الدعوه بنجاح");
                location.reload();
              } else {
                alert("حدث خطأ أثناء تحديث الدعوه");
              }
            } catch (error) {
              alert("خطأ في الاتصال بالخادم");
            }
          }

          // Delete invitation
          async function deleteInvitation(id) {
            if (confirm("هل أنت متأكد من حذف هذه الدعوه؟")) {
              try {
                const response = await fetch("/api/invitations/" + id, {
                  method: "DELETE",
                });
                if (response.ok) {
                  alert("تم حذف الدعوه بنجاح");
                  location.reload();
                } else {
                  alert("حدث خطأ أثناء حذف الدعوه");
                }
              } catch (error) {
                alert("خطأ في الاتصال بالخادم");
              }
            }
          }

          // Search invitations
          document
            .getElementById("searchInvitations")
            .addEventListener("input", async function () {
              const query = this.value.trim();
              try {
                const response = await fetch(
                  "/api/invitations/search?invitationNumber=" +
                    encodeURIComponent(query)
                );
                if (response.ok) {
                  const data = await response.json();
                  const tbody = document.querySelector(
                    "#invitationsTable tbody"
                  );
                  tbody.innerHTML = "";
                  if (data.data.length === 0) {
                    tbody.innerHTML =
                      '<tr><td colspan="10">لا توجد دعوات</td></tr>';
                    return;
                  }
                  data.data.forEach((invitation) => {
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-id", invitation._id);
                    tr.innerHTML = `
                <td>${invitation.invitationNumber}</td>
                <td>${
                  invitation.invitationDate
                    ? new Date(invitation.invitationDate)
                        .toISOString()
                        .substring(0, 10)
                    : ""
                }</td>
                <td>${invitation.meetingType}</td>
                <td>${invitation.memberName}</td>
                <td>${invitation.memberTitleEnd}</td>
                <td>${invitation.sessionNumber}</td>
                <td>${invitation.meetingPlace}</td>
                <td>${invitation.subject}</td>
                <td><button class="button edit" onclick="editInvitation('${
                  invitation._id
                }')">تعديل</button></td>
                <td><button class="button delete" onclick="deleteInvitation('${
                  invitation._id
                }')">حذف</button></td>
              `;
                    tbody.appendChild(tr);
                  });
                } else {
                  alert("فشل في جلب الدعوات");
                }
              } catch (error) {
                alert("خطأ في الاتصال بالخادم");
              }
            });
        </script>
      </div>
    </div>
  </body>
</html>
